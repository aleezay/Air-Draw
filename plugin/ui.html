<!doctype html>
<html>
<body></body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<script>
  const signaling = io("/", { transports: ["websocket"], path: "/socket.io" });
  const pc = new RTCPeerConnection();

  pc.ondatachannel = (e) => {
    const dc = e.channel;
    dc.onmessage = (ev) => {
      parent.postMessage({ pluginMessage: JSON.parse(ev.data) }, "*");
    };
  };

  pc.onicecandidate = e => e.candidate && signaling.emit("signal", { candidate: e.candidate });

  signaling.on("signal", async ({ sdp, type, candidate }) => {
    if (candidate) return pc.addIceCandidate(candidate);
    if (sdp) {
      await pc.setRemoteDescription({ type, sdp });
      const ans = await pc.createAnswer();
      await pc.setLocalDescription(ans);
      signaling.emit("signal", { sdp: ans.sdp, type: ans.type });
    }
  });
</script>
</html>
